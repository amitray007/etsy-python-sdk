# Weekly maintenance check — detects Etsy API changes and audits SDK coverage
name: Maintenance Check

on:
  schedule:
    # Every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  maintenance-check:
    name: Check API Changes & Audit SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch latest spec
        id: fetch
        run: |
          set +e
          python scripts/fetch_spec.py
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -eq 0 ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in Etsy API spec"
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "Error fetching spec"
            exit 1
          fi

      - name: Diff specs
        if: steps.fetch.outputs.changes == 'true'
        run: python scripts/diff_spec.py

      - name: Run SDK audit
        run: |
          # Ensure baseline exists for audit
          if [ ! -f specs/baseline.json ]; then
            cp specs/latest.json specs/baseline.json
          fi
          python scripts/audit_sdk.py

      - name: Upload diff report
        if: steps.fetch.outputs.changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-report
          path: specs/diff-report.md

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: specs/audit-report.md

      - name: Build issue body
        if: steps.fetch.outputs.changes == 'true'
        run: |
          {
            echo "## Etsy API Drift Detected"
            echo ""
            echo "The weekly maintenance check found changes in the Etsy OpenAPI spec."
            echo ""
            echo "### Diff Report"
            echo ""
            cat specs/diff-report.md
            echo ""
            echo "### SDK Coverage"
            echo ""
            sed -n '/## Coverage Summary/,/^## [^C]/p' specs/audit-report.md | head -20
            echo ""
            echo "---"
            echo ""
            echo "**Next steps:**"
            echo "1. Review the changes above"
            echo '2. Run `/maintain:audit` to get actionable guidance'
            echo "3. Implement necessary SDK updates"
            echo '4. Run `/maintain:test` to validate'
            echo '5. Update baseline: `cp specs/latest.json specs/baseline.json`'
            echo ""
            echo "*Auto-generated by [Maintenance Check](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})*"
          } > issue-body.md

      - name: Create or update issue on API drift
        if: steps.fetch.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh issue list --label "api-drift" --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "Updating existing issue #${EXISTING}"
            gh issue edit "$EXISTING" --body-file issue-body.md
            gh issue comment "$EXISTING" --body "Updated $(date -u +%Y-%m-%dT%H:%M:%SZ): New spec changes detected. Issue body updated with latest diff."
          else
            echo "Creating new api-drift issue"
            gh issue create \
              --title "Etsy API drift detected" \
              --body-file issue-body.md \
              --label "api-drift"
          fi

      - name: Close drift issue if no changes
        if: steps.fetch.outputs.changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh issue list --label "api-drift" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            echo "No API changes detected — closing issue #${EXISTING}"
            gh issue close "$EXISTING" --comment "Spec matches baseline as of $(date -u +%Y-%m-%dT%H:%M:%SZ). Closing automatically."
          else
            echo "No open api-drift issue to close"
          fi
