# Weekly maintenance check â€” detects Etsy API changes and audits SDK coverage
name: Maintenance Check

on:
  schedule:
    # Every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-api-changes:
    name: Check for API Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch latest spec
        id: fetch
        run: |
          python scripts/fetch_spec.py
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in Etsy API spec"
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "Error fetching spec"
            exit 1
          fi
        # fetch_spec.py returns 1 for no-changes, which is not an error
        continue-on-error: true

      - name: Diff specs
        if: steps.fetch.outputs.changes == 'true'
        run: python scripts/diff_spec.py

      - name: Upload diff report
        if: steps.fetch.outputs.changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-report
          path: specs/diff-report.md

  audit-sdk-coverage:
    name: Audit SDK Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch spec for audit
        run: |
          python scripts/fetch_spec.py || true
          # Ensure baseline exists for audit
          if [ ! -f specs/baseline.json ]; then
            cp specs/latest.json specs/baseline.json
          fi

      - name: Run SDK audit
        run: python scripts/audit_sdk.py

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: specs/audit-report.md
